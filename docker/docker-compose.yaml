# Common environment for services
x-common-env: &common-env
  tty: true
  stdin_open: true
  stop_grace_period: 1s

# Services
services:
  realsense: 
    build:
      context: .
      dockerfile: Dockerfile.vision
      target: realsense  
      args:
        USER: realsense
        LIBREALSENSE_VERSION: 2.56.2
    <<: *common-env
    network_mode: host
    image: vision-tdk:realsense
    container_name: tdk-realsense
    volumes:
      - /dev:/dev
      - $PWD/../src/realsense-pkg:/home/realsense/tdk_ros2_ws/src/realsense-ros
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - ROS_DOMAIN_ID=42
    group_add:
      - video
    privileged: true
    devices:
      - /dev:/dev
    device_cgroup_rules:
      - "c 81:* rmw"
      - "c 189:* rmw"
    command: bash
    #bash -ic "colcon build && ros2 launch realsense2_camera rs_launch.py"

  gui:
    build:
      context: .
      dockerfile: Dockerfile.vision
      target: gui
      args:
        USER: gui
    <<: *common-env
    network_mode: host
    image: vision-tdk:gui
    container_name: tdk-gui
    volumes:
      # X11 socket
      - /tmp/.X11-unix:/tmp/.X11-unix
      - $HOME/.Xauthority:/home/gui/.Xauthority
    environment:
      - DISPLAY=${DISPLAY}
      - ROS_DOMAIN_ID=42
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
    command: ros2 launch foxglove_bridge foxglove_bridge_launch.xml address:=localhost port:=8765

  opencv:
    build:
      context: .
      dockerfile: Dockerfile.vision
      target: opencv
      args:
        USER: opencv
    <<: *common-env
    network_mode: host
    image: vision-tdk:opencv
    container_name: tdk-opencv
    environment:
      - RMW_IMPLEMENTATION=rmw_cyclonedds_cpp
      - ROS_DOMAIN_ID=42
    volumes:
        - $PWD/../src/opencv-pkg:/home/opencv/tdk_ros2_ws/src/opencv_ros
    command: bash
  
  micro-ros-agent:
    image: microros/micro-ros-agent:humble
    container_name: micro-ros-agent
    network_mode: host
    devices:
      - /dev/serial/by-id/usb-STMicroelectronics_STM32_STLink_066BFF3833554B3043185746-if02:/dev/ttyAgent
    command: >
      serial --dev /dev/ttyAgent --baudrate 115200 -v6
    group_add:
      - dialout
    restart: unless-stopped
    
  task:
    build:
      context: .
      dockerfile: Dockerfile.task
      args:
        USERNAME: abao          
        USER_UID: 1001    
        USER_GID: 1001
    user: "1001:1001"
    container_name: tdk-task
    stdin_open: true
    tty: true
    privileged: true
    network_mode: host
    working_dir: /home/abao/tdk_ros2_ws
    environment:
      - DISPLAY=${DISPLAY}
      - XAUTHORITY=/home/abao/.Xauthority
      - ROS_WS=/home/abao/tdk_ros2_ws
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /dev:/dev
      - ../:/home/abao/tdk_ros2_ws
      - ${HOME}/.Xauthority:/home/abao/.Xauthority:ro
    command: /bin/bash

